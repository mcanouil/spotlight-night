---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

# Spotlight Night Poster

<!-- badges: start -->
[![License](https://img.shields.io/github/license/mcanouil/spotlight-night)](LICENSE)
<!-- badges: end -->

```{r, include = FALSE}
source("assets/create_spotlight_night.R")

rscripts <- list.files(path = "R", pattern = "^20.*\\.R$", full.names = TRUE)

posters <- sub("\\.R$", "", basename(rscripts))
pngs <- sprintf("posters/%s/%s.png", posters, posters)
thumbs <- sprintf("thumbs/%s.png", posters)

outdated <- !file.exists(thumbs) |
  (
    as.POSIXct(posters) > file.mtime(thumbs) &
    file.mtime(thumbs) < sapply(
      X = file.mtime(rscripts),
      FUN = function(x, y) max(c(x, y)),
      y = file.mtime("assets/create_spotlight_night.R")
    )
  )
message("Rendering posters ...")
invisible(lapply(rscripts[which(outdated)], source, encoding = "UTF-8"))

message("Rendering thumbs images ...")
dir.create("thumbs", showWarnings = FALSE, recursive = TRUE)
invisible(Map(
  f = function(path_in, path_out) {
    if (!file.exists(path_in)) return(NULL)
    image <- magick::image_read(path_in)
    image <- magick::image_resize(image, "192x")
    magick::image_write(image, path_out)
  },
  sub("\\.png", "_01.png", pngs)[which(outdated)],
  thumbs[which(outdated)]
))

message("Removing past posters ...")
unlink(dirname(pngs)[as.Date(posters) < Sys.Date()], recursive = TRUE, force = TRUE)
if (length(list.files("posters")) == 0) {
  file.create("posters/.gitkeep")
} else {
  unlink("posters/.gitkeep")
}
if (length(list.files("thumbs")) == 0) {
  file.create("thumbs/.gitkeep")
} else {
  unlink("thumbs/.gitkeep")
}
```

```{r, results = "asis", echo = FALSE}
cell <- sprintf(
  paste0(
    '<td align = "center">',
      '<img alt="Poster for %s Spotlight night" src="%s" width="100%%" height="auto" />',
      "<br/>",
      "%s",
    "</td>"
  ),
  posters, thumbs, posters
)

if (any(future_gn <- as.Date(posters) >= Sys.Date())) {
  cell[which(future_gn)] <- sprintf(
    paste0(
      '<td align = "center">',
        '<a href="%s">',
          '<img alt="Poster for %s Spotlight night" src="%s" width="100%%" height="auto" />',
          "<br/>",
          "%s",
        "</a>",
      "</td>"
    ),
    dirname(pngs), posters, thumbs, posters
  )[which(future_gn)]
}

cols <- 4
rows <- ceiling(length(cell) / cols)

row_id <- rep(seq_len(rows), each = cols, length.out = length(cell))
row_cells <- split(cell, row_id)

cat("<table>\n")
cat(paste0("<tr>", sapply(row_cells, paste, collapse = ""), "</tr>"), sep = "")
cat("</table>\n")
```
